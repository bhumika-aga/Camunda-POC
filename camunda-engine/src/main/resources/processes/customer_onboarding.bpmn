<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
  xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  id="Definitions_CustomerOnboarding"
  targetNamespace="http://bpmn.io/schema/bpmn"
  exporter="Camunda Modeler"
  exporterVersion="5.20.0">

  <bpmn:process id="customer_onboarding" name="Customer Onboarding Process" isExecutable="true"
    camunda:historyTimeToLive="180">

    <!-- ==================== START EVENT ==================== -->
    <bpmn:startEvent id="StartEvent_CustomerOnboarding" name="Customer Onboarding Started">
      <bpmn:outgoing>Flow_StartToValidate</bpmn:outgoing>
    </bpmn:startEvent>

    <!-- ==================== SERVICE TASK 1: VALIDATE DATA (External Task) ==================== -->
    <bpmn:serviceTask id="Task_ValidateData" name="Validate Customer Data"
      camunda:type="external"
      camunda:topic="validateData"
      camunda:taskPriority="10">
      <bpmn:extensionElements>
        <camunda:inputOutput>
          <camunda:inputParameter name="customerName">${customerName}</camunda:inputParameter>
          <camunda:inputParameter name="email">${email}</camunda:inputParameter>
          <camunda:inputParameter name="documentType">${documentType}</camunda:inputParameter>
        </camunda:inputOutput>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_StartToValidate</bpmn:incoming>
      <bpmn:outgoing>Flow_ValidateToReview</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- Error Boundary Event for Validation Errors -->
    <bpmn:boundaryEvent id="BoundaryEvent_ValidationError" name="Validation Error"
      attachedToRef="Task_ValidateData">
      <bpmn:outgoing>Flow_ErrorToHandler</bpmn:outgoing>
      <bpmn:errorEventDefinition id="ErrorEventDefinition_Validation"
        errorRef="Error_ValidationFailed" />
    </bpmn:boundaryEvent>

    <!-- ==================== USER TASK: REVIEW DOCUMENTS ==================== -->
    <bpmn:userTask id="Task_ReviewDocuments"
                   name="Review Customer Documents"
                   camunda:assignee="demo">
      <bpmn:extensionElements>
        <camunda:formData>
          <camunda:formField id="customerName" label="Customer Name" type="string">
            <camunda:validation>
              <camunda:constraint name="readonly" />
            </camunda:validation>
          </camunda:formField>
          <camunda:formField id="email" label="Email" type="string">
            <camunda:validation>
              <camunda:constraint name="readonly" />
            </camunda:validation>
          </camunda:formField>
          <camunda:formField id="documentType" label="Document Type" type="string">
            <camunda:validation>
              <camunda:constraint name="readonly" />
            </camunda:validation>
          </camunda:formField>
          <camunda:formField id="validationMessage" label="Validation Result" type="string">
            <camunda:validation>
              <camunda:constraint name="readonly" />
            </camunda:validation>
          </camunda:formField>
          <camunda:formField id="documentsApproved" label="Approve Documents?" type="boolean"
            defaultValue="false" />
          <camunda:formField id="reviewerComments" label="Reviewer Comments" type="string" />
        </camunda:formData>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ValidateToReview</bpmn:incoming>
      <bpmn:outgoing>Flow_ReviewToGateway</bpmn:outgoing>
    </bpmn:userTask>

    <!-- ==================== EXCLUSIVE GATEWAY: CHECK APPROVAL ==================== -->
    <bpmn:exclusiveGateway id="Gateway_CheckApproval" name="Documents Approved?">
      <bpmn:incoming>Flow_ReviewToGateway</bpmn:incoming>
      <bpmn:outgoing>Flow_Approved</bpmn:outgoing>
      <bpmn:outgoing>Flow_Rejected</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <!-- ==================== SERVICE TASK 2: CREATE ACCOUNT (External Task) ==================== -->
    <bpmn:serviceTask id="Task_CreateAccount" name="Create Customer Account"
      camunda:type="external"
      camunda:topic="createAccount"
      camunda:taskPriority="5">
      <bpmn:extensionElements>
        <camunda:inputOutput>
          <camunda:inputParameter name="customerName">${customerName}</camunda:inputParameter>
          <camunda:inputParameter name="email">${email}</camunda:inputParameter>
          <camunda:inputParameter name="documentType">${documentType}</camunda:inputParameter>
          <camunda:inputParameter name="reviewerComments">${reviewerComments}</camunda:inputParameter>
        </camunda:inputOutput>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_Approved</bpmn:incoming>
      <bpmn:outgoing>Flow_CreateToEnd</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- ==================== END EVENTS ==================== -->
    <bpmn:endEvent id="EndEvent_Success" name="Onboarding Completed Successfully">
      <bpmn:incoming>Flow_CreateToEnd</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:endEvent id="EndEvent_Rejected" name="Onboarding Rejected">
      <bpmn:incoming>Flow_Rejected</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:endEvent id="EndEvent_ValidationFailed" name="Validation Failed">
      <bpmn:incoming>Flow_ErrorHandlerToEnd</bpmn:incoming>
    </bpmn:endEvent>

    <!-- ==================== ERROR HANDLER TASK ==================== -->
    <bpmn:serviceTask id="Task_HandleError" name="Handle Validation Error"
      camunda:type="external"
      camunda:topic="handleError">
      <bpmn:extensionElements>
        <camunda:inputOutput>
          <camunda:outputParameter name="errorOccurred">${true}</camunda:outputParameter>
        </camunda:inputOutput>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ErrorToHandler</bpmn:incoming>
      <bpmn:outgoing>Flow_ErrorHandlerToEnd</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- ==================== SEQUENCE FLOWS ==================== -->
    <bpmn:sequenceFlow id="Flow_StartToValidate" sourceRef="StartEvent_CustomerOnboarding"
      targetRef="Task_ValidateData" />
    <bpmn:sequenceFlow id="Flow_ValidateToReview" sourceRef="Task_ValidateData"
      targetRef="Task_ReviewDocuments" />
    <bpmn:sequenceFlow id="Flow_ReviewToGateway" sourceRef="Task_ReviewDocuments"
      targetRef="Gateway_CheckApproval" />

    <bpmn:sequenceFlow id="Flow_Approved" name="Yes" sourceRef="Gateway_CheckApproval"
      targetRef="Task_CreateAccount">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${documentsApproved == true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>

    <bpmn:sequenceFlow id="Flow_Rejected" name="No" sourceRef="Gateway_CheckApproval"
      targetRef="EndEvent_Rejected">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${documentsApproved == false}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>

    <bpmn:sequenceFlow id="Flow_CreateToEnd" sourceRef="Task_CreateAccount"
      targetRef="EndEvent_Success" />
    <bpmn:sequenceFlow id="Flow_ErrorToHandler" sourceRef="BoundaryEvent_ValidationError"
      targetRef="Task_HandleError" />
    <bpmn:sequenceFlow id="Flow_ErrorHandlerToEnd" sourceRef="Task_HandleError"
      targetRef="EndEvent_ValidationFailed" />

  </bpmn:process>

  <!-- ==================== ERROR DEFINITION ==================== -->
  <bpmn:error id="Error_ValidationFailed" name="Validation Error" errorCode="VALIDATION_ERROR" />

  <!-- ==================== DIAGRAM (Visual Layout) ==================== -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_CustomerOnboarding">
    <bpmndi:BPMNPlane id="BPMNPlane_CustomerOnboarding" bpmnElement="customer_onboarding">

      <!-- Start Event -->
      <bpmndi:BPMNShape id="StartEvent_CustomerOnboarding_di"
        bpmnElement="StartEvent_CustomerOnboarding">
        <dc:Bounds x="179" y="209" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="155" y="252" width="85" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Validate Data Task -->
      <bpmndi:BPMNShape id="Task_ValidateData_di" bpmnElement="Task_ValidateData">
        <dc:Bounds x="280" y="187" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>

      <!-- Error Boundary Event -->
      <bpmndi:BPMNShape id="BoundaryEvent_ValidationError_di"
        bpmnElement="BoundaryEvent_ValidationError">
        <dc:Bounds x="312" y="249" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="294" y="292" width="73" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Review Documents Task -->
      <bpmndi:BPMNShape id="Task_ReviewDocuments_di" bpmnElement="Task_ReviewDocuments">
        <dc:Bounds x="450" y="187" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>

      <!-- Gateway -->
      <bpmndi:BPMNShape id="Gateway_CheckApproval_di" bpmnElement="Gateway_CheckApproval"
        isMarkerVisible="true">
        <dc:Bounds x="625" y="202" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="606" y="172" width="88" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Create Account Task -->
      <bpmndi:BPMNShape id="Task_CreateAccount_di" bpmnElement="Task_CreateAccount">
        <dc:Bounds x="750" y="187" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>

      <!-- End Event Success -->
      <bpmndi:BPMNShape id="EndEvent_Success_di" bpmnElement="EndEvent_Success">
        <dc:Bounds x="922" y="209" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="900" y="252" width="81" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- End Event Rejected -->
      <bpmndi:BPMNShape id="EndEvent_Rejected_di" bpmnElement="EndEvent_Rejected">
        <dc:Bounds x="632" y="322" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="608" y="365" width="85" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Error Handler Task -->
      <bpmndi:BPMNShape id="Task_HandleError_di" bpmnElement="Task_HandleError">
        <dc:Bounds x="280" y="350" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>

      <!-- End Event Validation Failed -->
      <bpmndi:BPMNShape id="EndEvent_ValidationFailed_di" bpmnElement="EndEvent_ValidationFailed">
        <dc:Bounds x="452" y="372" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="432" y="415" width="77" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Sequence Flows -->
      <bpmndi:BPMNEdge id="Flow_StartToValidate_di" bpmnElement="Flow_StartToValidate">
        <di:waypoint x="215" y="227" />
        <di:waypoint x="280" y="227" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_ValidateToReview_di" bpmnElement="Flow_ValidateToReview">
        <di:waypoint x="380" y="227" />
        <di:waypoint x="450" y="227" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_ReviewToGateway_di" bpmnElement="Flow_ReviewToGateway">
        <di:waypoint x="550" y="227" />
        <di:waypoint x="625" y="227" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_Approved_di" bpmnElement="Flow_Approved">
        <di:waypoint x="675" y="227" />
        <di:waypoint x="750" y="227" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="704" y="209" width="18" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_Rejected_di" bpmnElement="Flow_Rejected">
        <di:waypoint x="650" y="252" />
        <di:waypoint x="650" y="322" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="658" y="284" width="15" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_CreateToEnd_di" bpmnElement="Flow_CreateToEnd">
        <di:waypoint x="850" y="227" />
        <di:waypoint x="922" y="227" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_ErrorToHandler_di" bpmnElement="Flow_ErrorToHandler">
        <di:waypoint x="330" y="285" />
        <di:waypoint x="330" y="350" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_ErrorHandlerToEnd_di" bpmnElement="Flow_ErrorHandlerToEnd">
        <di:waypoint x="380" y="390" />
        <di:waypoint x="452" y="390" />
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</bpmn:definitions>